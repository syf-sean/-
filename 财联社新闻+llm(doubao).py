from openai import OpenAI
import csv
import os

client = OpenAI(
    api_key=os.environ.get("DouBao_API_KEY"),
    base_url="https://ark.cn-beijing.volces.com/api/v3",
    timeout=1800,
)


# prompt_template = (
#     "我将提供两部分内容：\n"
#     "1. 今日新闻（含标题与摘要），格式为：*标题 发布时间：摘要*\n"
#     "2. 投资日历（涵盖今日及未来十五天内的重要财经事件），格式为：*2025-07-25 星期五 ① 新闻一 ② 新闻二*\n\n"
#
#     "你的任务分为三部分，请严格按照要求输出，**分析范围严格限定为中国大陆的 A 股市场及其上市公司**。\n\n"
#
#     "特别注意：请勿分析、推荐或提及未在 A 股上市的公司，例如：\n"
#     "华为（未上市）、特斯拉（美股）、腾讯（港股）、台积电（台股）等。\n"
#     "如遇新闻中出现这些公司，**忽略其个股影响，专注相关 A 股产业链公司分析。**\n\n"
#
#     "**任务一：热点市场判断**\n"
#     "根据新闻与事件，输出所有可能成为短期市场热点或长期具备上涨潜力的*A 股板块*（如人工智能、新能源、医药、券商等）。\n"
#     "请用以下格式输出（每条请换一行）：\n"
#     "*高热度市场：相应新闻的时间-人工智能-原因（不超过10字）、相应新闻的时间-新能源汽车-原因（不超过10字）、相应新闻的时间-医疗器械-原因（不超过10字）*\n\n"
#     "示例：高热度市场：2025-07-25 10:00:55-人工智能-人工智能大会召开，2025-07-25 9:00:15-新能源汽车-国家政策大力扶持"
#
#     "**任务二：个股推荐（仅限 A 股可交易股票）**\n"
#     "根据任务一识别的热点板块，为每个板块推荐不多于三只稳定且有上涨趋势的 A 股股票，优先从新闻里提到的A股上市公司里推荐。\n"
#     "请用以下格式输出（每条请换一行）：*板块-相应新闻的时间-股票名-股票代码-推荐理由（不超过10字）*\n"
#     "示例：新能源汽车-2025-07-25 9:00:15-比亚迪-002594-销量强劲\n"
#     "所有推荐股票必须为**中国 A 股市场已上市、可交易的公司**。\n\n"
#
#     "**任务三：新闻关联个股分析（必须为 A 股上市公司）**\n"
#     "新闻中所有提及的具体公司，先判断其是否为中国 A 股上市公司，**只有在 A 股上市的公司才可以分析其股价走势，未上市或境外上市公司请完全忽略，不输出任何信息。**\n"
#     "请判断相关新闻对其股价的影响是上涨、下跌，还是中性（无法判断）。\n"
#     "请用以下格式输出（每条请换一行）：*股票名-股票代码-涨/跌/中立-原因（不超过10字）-相应新闻的时间*\n"
#     "按格式输出不要额外加任何内容"
#     "示例：恒瑞医药-600276-涨-新药获批-2025-07-25 15:00:15\n\n"
#
#     "未在 A 股上市的公司不要在任何任务中出现。\n"
#     "输出结构要清晰、分部分、格式统一，语言专业。\n\n"
#
#     "新闻内容如下：\n{news}\n\n"
#     "投资日历如下：\n{event}"
# )

prompt_template = (
    "我将提供两部分内容：\n"
    "1. 今日新闻（含标题与摘要），格式为：*标题 发布时间：摘要*\n"
    "2. 投资日历（涵盖今日及未来十五天内的重要财经事件），格式为：*2025-07-25 星期五 ① 新闻一 ② 新闻二*\n\n"

    "你的任务分为三部分，请严格按照要求输出，**分析范围严格限定为中国大陆的 A 股市场及其上市公司**。\n\n"

    "⚠️ 特别注意：\n"
    "1. 请勿分析、推荐或提及未在 A 股上市的公司，例如：华为（未上市）、特斯拉（美股）、腾讯（港股）、台积电（台股）等。\n"
    "2. 如遇这些公司，**忽略其个股影响，仅分析可能受益的 A 股产业链公司或受到影响的 A  股板块**。\n"
    "3. 若新闻内容为**未经官方确认的传闻**，只要可能影响市场预期，也请照常分析，但需在每条结尾以括号注明“暂为传闻”。\n\n"

    "——————\n"
    "**任务一：热点市场判断**\n"
    "请识别可能成为短期市场热点或长期具备上涨潜力的 **A 股板块**（如人工智能、新能源、医药、券商、军工等）。\n"
    "输出格式如下（每条请换一行）：\n"
    "高热度市场：\n"
    "发布时间-板块名称-简要原因（不超10字）\n"
    "示例：2025-07-25 10:00:55-人工智能-大会召开\n\n"

    "——————\n"
    "**任务二：个股推荐（仅限 A 股可交易股票）**\n"
    "根据任务一中识别的热点板块，推荐不多于三只 A 股股票（稳定、有上涨趋势）。优先选取新闻中提及的 A 股公司。\n"
    "输出格式如下（每条请换一行）：\n"
    "板块-发布时间-股票名-股票代码-推荐理由（不超10字）\n"
    "示例：新能源汽车-2025-07-25 09:00:15-比亚迪-002594-销量强劲\n\n"

    "——————\n"
    "**任务三：新闻关联个股分析（必须为 A 股上市公司）**\n"
    "新闻中所有提到的公司，若为 A 股上市公司，请判断其股价影响为“涨”、“跌”或“中立”。\n"
    "未上市或境外上市的公司请完全忽略，不要输出。\n"
    "若新闻内容为未经官方确认的传闻，只要可能影响市场预期，则不视为传闻，根据新闻内容请照常分析，但需在每条结尾以括号注明“暂为传闻”。\n"
    "输出格式如下（每条请换一行）：\n"
    "股票名-股票代码-涨/跌/中立-简要原因（不超10字）-发布时间\n"
    "示例：恒瑞医药-600276-涨-新药获批-2025-07-25 15:00:15\n\n"

    "❗注意：如某条为市场传闻，请在分析内容末尾加（暂为传闻）\n"
    "未在 A 股上市的公司不要在任何任务中出现。\n"
    "输出结构需清晰、分部分、格式统一、语言专业。\n\n"

    "新闻内容如下：\n{news}\n\n"
    "投资日历如下：\n{event}"
)


with open("数据/财联社新闻clean.csv", "r", encoding="utf-8") as f:
    reader = csv.reader(f)
    rows = [row[0] for row in reader if row]

news = "\n".join(rows)

with open("数据/财联社投资日历clean.csv", "r", encoding="utf-8") as f:
    reader = csv.reader(f)
    rows = [row[0] for row in reader if row]

event = "\n".join(rows)

prompt = prompt_template.format(news=news, event=event)

try:
    response = client.chat.completions.create(
        model="doubao-seed-1-6-250615",
        messages=[
            {
                "role": "system",
                "content": "你是一名专业且严谨的金融舆情分析助手，专注于解析最新新闻和财经事件对**中国 A 股市场**的潜在影响。\n\n",
            },
            {
                "role": "user",
                "content": prompt,
            }
        ],
        extra_body={
            "thinking": {
                "type": "disabled",  # 不使用深度思考能力
                # "type": "enabled", # 使用深度思考能力
                # "type": "auto", # 模型自行判断是否使用深度思考能力
            }
        },
    )
    response = response.choices[0].message.content
    print(response)
except Exception as e:
    print(e)



'''
### 任务一：热点市场判断  
2025-07-28 09:28:14-公募基金-养老金改革利好  
2025-07-28 12:37:46-储能-江苏华辰产品破圈  
2025-07-28 09:23:50-人工智能-AI报告发布  
2025-07-28 12:13:27-PCB概念-早盘再度走强  
2025-07-28 09:06:45-创新药-商业化井喷  

### 任务二：个股推荐（仅限A股可交易股票）  
储能-2025-07-28 12:37:46-江苏华辰-603097-储能订单充足  
人工智能-2025-07-28 09:23:50-中科曙光-603019-AI算力核心  
创新药-2025-07-28 09:06:45-恒瑞医药-600276-BD合作突破  

### 任务三：新闻关联个股分析（必须为A股上市公司）  
江苏华辰-603097-涨-储能产品破圈-2025-07-28 12:37:46  
恒瑞医药-600276-涨-创新药BD协议-2025-07-28 10:59:24  
居然智家-000785-中立-董事长传闻未公告-2025-07-28 11:20:04（暂为传闻）  
上纬新材-688585-涨-2025首只10倍股-2025-07-28 11:47:06  
舒泰神-300204-涨-完成2倍涨幅-2025-07-28 11:47:06  
*ST宇顺-002289-涨-完成2倍涨幅-2025-07-28 11:47:06  
联合化学-301209-涨-完成2倍涨幅-2025-07-28 11:47:06
西藏旅游-600749-涨-6连板走势-2025-07-28 12:13:27
'''
