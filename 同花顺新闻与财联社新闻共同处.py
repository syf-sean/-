from langchain_community.chat_models.tongyi import ChatTongyi
from dotenv import load_dotenv
import csv

load_dotenv()

# 初始化模型
llm = ChatTongyi(model="qwen-max")

prompt_template = (
    "你是一名专业、严谨的金融舆情分析助手，擅长从多来源财经信息中提炼出对**中国 A 股市场**具有实际影响的内容，尤其擅长识别不同来源中存在的**相似或交叉的新闻内容**。\n\n"

    "我将提供两部分内容，格式如下：\n"
    "1. 财联社的今日新闻（格式：*标题 发布时间：摘要*）\n"
    "2. 同花顺的财经要闻（格式：*时间 标题 [涉及股票代码与名称（若有）]：摘要*）\n\n"

    "请你完成以下任务，**分析范围严格限定为中国大陆 A 股市场及其上市公司**。\n"
    "以下内容请完全忽略，不参与分析：\n"
    "- 港股、美股、台股相关公司（如：腾讯、台积电、特斯拉等）\n"
    "- 未在 A 股上市的公司（如：华为）\n"
    "- 与 A 股无直接挂钩的**期货类新闻或合约本身**（如黄金期货、铜期货、股指期货等）\n\n"

    "如果新闻中提及未上市公司、港股、美股或期货，请只关注它们可能涉及的**A 股产业链相关上市公司**，若与A股完全无关则不要输出。\n\n"

    "**【任务说明】**\n"
    "请你比较来自财联社和同花顺的两组新闻，从中找出内容相似、主题一致或报道相同事件的新闻，并进行如下整理：\n\n"
    "1. 归纳总结这组相似新闻共同传达的核心内容；\n"
    "2. 简要说明该新闻对 A 股市场的可能影响（如提振情绪、抑制走势、行业预期改善等）；\n"
    "3. 明确列出涉及的 A 股相关公司（股票代码+名称），并判断对其股价影响（涨 / 跌 / 中立）；\n"
    "4. 原样列出对应的原始新闻内容。\n\n"

    "**【输出格式如下】**（严格遵循）：\n"
    "*相似新闻内容概括：xxx（简洁总结）*\n"
    "*A 股可能受到的影响：xxx（简洁描述市场影响）*\n"
    "*涉及股票：600519-贵州茅台-涨，000858-五粮液-中立（如无相关的A股股票可忽略此项，若为同花顺指数板块代码也忽略此项）*\n"
    "*原始新闻：*\n"
    "财联社：xxx\n"
    "同花顺：xxx\n\n"

    "**请注意以下格式和规则要求：**\n"
    "- 输出结构必须清晰分明、统一规范。\n"
    "- 每一组相似新闻为一个独立段落。\n"
    "- 所有推荐或分析的股票必须为中国大陆 A 股市场可交易股票。\n\n"

    "--------------------------\n"
    "财联社新闻如下：\n{cai_news}\n\n"
    "同花顺财经要闻如下：\n{shun_news}"
)

with open("财联社新闻.csv", "r", encoding="utf-8") as f:
    reader = csv.reader(f)
    rows = [row[0] for row in reader if row]

cai_news = "\n".join(rows)

with open("同花顺财经要闻.csv", "r", encoding="utf-8") as f:
    reader = csv.reader(f)
    rows = [row[0] for row in reader if row]

shun_news = "\n".join(rows)

prompt = prompt_template.format(cai_news=cai_news, shun_news=shun_news)

try:
    response = llm.invoke(prompt).content.strip()
    print(response)
except Exception as e:
    print(e)

"""
### 相似新闻内容概括：恒瑞医药与GSK达成125亿美元组合授权协议
**A 股可能受到的影响：提振情绪，利好创新药板块**
*涉及股票：600276-恒瑞医药-涨*
*原始新闻：*
财联社：创新药BD热潮持续 恒瑞医药与GSK达成125亿美元组合授权协议 2025-07-28 10:59:24: ①首付款5亿美元，BD总金额达125亿美元； ②今年上半年，中国药企License-out金额已突破608亿美元，超过去年全年，全年增速有望达到近年高位。
同花顺：860亿元新纪录！药企龙头大动作 [股票代码: 886015-股票名: 创新药 股票代码: 600276-股票名: 恒瑞医药 股票代码: 01276-股票名: 恒瑞医药 股票代码: GSK-股票名: 葛兰素史克 股票代码: HK1276-股票名: 恒瑞医药 ]:　　中国创新药出海再次刷新纪录！　　7月28日，恒瑞医药公告，公司与GSK（葛兰素史克）达成协议，将HRS-9821项目除中国区外的全球独家权利和至多11个项目除中国区外的全球独家许可的独家选择权有偿许可给GSK，该笔交易的潜在总金额高达1

### 相似新闻内容概括：居然智家董事长汪林朋坠楼身亡传闻及公司回应
**A 股可能受到的影响：抑制走势，负面影响市场情绪**
*涉及股票：000785-居然智家-跌*
*原始新闻：*
财联社：居然智家董事长汪林朋坠楼身亡？公司回应 2025-07-28 11:20:04: 截至发稿时，上市公司居然智家还未发布相关公告。
同花顺：居然智家董事长跳楼身亡？上市公司回应：最快今天公告 [股票代码: 000785-股票名: 居然智家 ]:　　7月28日，居然智家（000785）大幅低开，甚至一度报出跌停价。截至午间收盘，居然智家跌8.23%，报2.9元/股，总市值180.6亿元。　　消息面上，网传居然智家董事长汪林朋跳楼身亡。针对上述传闻，证券时报·e公司记者以投资者身份向

### 相似新闻内容概括：焦煤期货价格暴跌
**A 股可能受到的影响：抑制煤炭板块走势**
*涉及股票：无直接相关的A股股票*
*原始新闻：*
财联社：焦煤早盘暴跌超10%，商品期货全线飘绿，交易所出手限仓交易 2025-07-28 11:58:06: 在商品疯涨过后或出现品种的持续轮换和涨跌互现，建议做好仓位控制和风险管理。
同花顺：大宗商品狂欢退潮！焦煤主力合约跌超10% [股票代码: JMZL2-股票名: 焦煤主连 股票代码: 881105-股票名: 煤炭开采加工 ]:　　狂欢过后，大宗商品市场热度“熄火”。　　7月28日早盘，国内期货市场商品多数“飘绿”，此前涨幅居前的焦煤、焦炭、玻璃、纯碱等悉数大跌。主力合约中，双焦领跌。截至上午收盘，焦煤跌超10%，焦炭跌幅达7.44%，此外主力合约中碳酸锂跌7.9
"""