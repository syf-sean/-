import pandas as pd
from langchain_community.chat_models.tongyi import ChatTongyi
from dotenv import load_dotenv
import csv

load_dotenv()

# 初始化模型
llm = ChatTongyi(model="qwen-max")


prompt_template = (
    "你是一名专业且严谨的金融舆情分析助手，专注于解析最新新闻和财经事件对**中国 A 股市场**的潜在影响。\n\n"

    "我将提供两部分内容：\n"
    "1. 今日新闻（含标题与摘要），格式为：*标题 发布时间：摘要*\n"
    "2. 投资日历（涵盖今日及未来十五天内的重要财经事件），格式为：*2025-07-25 星期五 ① 新闻一 ② 新闻二*\n\n"

    "你的任务分为三部分，请严格按照要求输出，**分析范围严格限定为中国大陆的 A 股市场及其上市公司**。\n\n"

    "特别注意：请勿分析、推荐或提及未在 A 股上市的公司，例如：\n"
    "华为（未上市）、特斯拉（美股）、腾讯（港股）、台积电（台股）等。\n"
    "如遇新闻中出现这些公司，**忽略其个股影响，专注相关 A 股产业链公司分析。**\n\n"

    "**任务一：热点市场判断**\n"
    "根据新闻与事件，判断哪些 A 股板块（如人工智能、新能源、医药、券商等）可能成为短期市场热点，具有上涨潜力。\n"
    "请用以下格式输出：\n"
    "*高热度市场：相应新闻的时间-人工智能-原因（不超过10字）、相应新闻的时间-新能源汽车-原因（不超过10字）、相应新闻的时间-医疗器械-原因（不超过10字）*\n\n"
    "示例：高热度市场：2025-07-25 10:00:55-人工智能-人工智能大会召开、2025-07-25 9:00:15-新能源汽车-国家政策大力扶持"

    "**任务二：个股推荐（仅限 A 股可交易股票）**\n"
    "根据任务一识别的热点板块，为每个板块推荐 2~3 只稳定且有上涨趋势的 A 股股票。\n"
    "推荐格式为：*板块-相应新闻的时间-股票名-股票代码-推荐理由（不超过10字）*\n"
    "示例：新能源汽车-2025-07-25 9:00:15-比亚迪-002594-销量强劲\n"
    "所有推荐股票必须为**中国 A 股市场已上市、可交易的公司**。\n\n"

    "**任务三：新闻关联个股分析（必须为 A 股上市公司）**\n"
    "如果新闻中提及了具体公司，请判断其是否为中国 A 股上市公司，**只有在 A 股上市的公司才可以分析其股价走势，未上市或境外上市公司请完全忽略，不输出任何信息。**\n"
    "请判断相关新闻对其股价的影响是上涨、下跌，还是中性（无法判断）。\n"
    "输出格式为：*股票名-股票代码-涨/跌/中立-原因-相应新闻的时间（不超过10字）*\n"
    "按格式输出不要额外加任何内容"
    "示例：恒瑞医药-600276-涨-新药获批-2025-07-25 15:00:15\n\n"

    "未在 A 股上市的公司不要在任何任务中出现。\n"
    "输出结构要清晰、分部分、格式统一，语言专业。\n\n"

    "新闻内容如下：\n{news}\n\n"
    "投资日历如下：\n{event}"
)

with open("数据/财联社新闻.csv", "r", encoding="utf-8") as f:
    reader = csv.reader(f)
    rows = [row[0] for row in reader if row]  # 读取每一行的第一个单元格，并排除空行

news = "\n".join(rows)

with open("数据/财联社投资日历.csv", "r", encoding="utf-8") as f:
    reader = csv.reader(f)
    rows = [row[0] for row in reader if row]  # 读取每一行的第一个单元格，并排除空行

event = "\n".join(rows)

prompt = prompt_template.format(news=news, event=event)

try:
    response = llm.invoke(prompt).content.strip()
    print(response)
except Exception as e:
    print(e)



'''
### 任务一：热点市场判断
高热度市场：
- 2025-07-28 12:37:46-新能源-储能产品“破圈”
- 2025-07-28 09:23:50-人工智能-中信智库发布AI报告
- 2025-07-28 12:13:27-PCB-算力硬件走强

### 任务二：个股推荐
- 新能源-2025-07-28 12:37:46-江苏华辰-603097-储能业务增长
- 新能源-2025-07-28 12:37:46-宁德时代-300750-电池龙头
- 人工智能-2025-07-28 09:23:50-科大讯飞-002230-AI技术领先
- 人工智能-2025-07-28 09:23:50-海康威视-002415-智能安防
- PCB-2025-07-28 12:13:27-深南电路-002916-PCB龙头
- PCB-2025-07-28 12:13:27-沪电股份-002463-高端PCB制造

### 任务三：新闻关联个股分析
- 江苏华辰-603097-涨-储能产品“破圈”-2025-07-28 12:37:46
- 恒瑞医药-600276-涨-与GSK达成协议-2025-07-28 10:59:24
'''
